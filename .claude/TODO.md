# üìã TODO List - DotsX

Date de mise √† jour : 2025-09-30

---

## ‚úÖ Version 1.0 - TERMIN√âE (100%)

### Features impl√©ment√©es
- [x] Refacto notation `~` ‚Üí `__home__` pour paths user-agnostic
- [x] Validation SSH stricte (uniquement `git@github.com:...`)
- [x] `dotsx git sync` atomique (add + commit + push en une commande)
- [x] `dotsx git pull` avec validation structure + symlinks
- [x] `MAX_BACKUPS_PER_FILE = 7` (conforme spec)
- [x] Commande `dotsx doctor` avec diagnostic complet + fix auto

---

## üü° Version 1.1 - EN COURS (0%)

### 1. Backup quotidien automatique
**Priorit√©:** MOYENNE
**Temps estim√©:** 30 min
**Fichiers concern√©s:**
- `src/lib/file.ts`
- Nouveau fichier : `src/lib/backup.ts` (optionnel pour refacto)

**Description:**
Actuellement, un backup est cr√©√© **√† chaque fois** qu'un symlink est modifi√©/cr√©√©. Selon CLAUDE.md, le backup devrait √™tre fait **maximum 1 fois par jour** pour le m√™me fichier.

**Impl√©mentation sugg√©r√©e:**

1. Cr√©er un fichier de m√©tadonn√©es `.dotsx/.last-backup.json` :
```json
{
  "symlinks/__home__/.zshrc": "2025-09-30",
  "symlinks/__home__/.config/Code/User/settings.json": "2025-09-29"
}
```

2. Modifier `FileLib.safeSymlink()` (ligne ~247) :
```typescript
async safeSymlink(systemPath: string, dotsxPath: string) {
  // ... existing checks ...

  const dotsxRelativePath = path.relative(DOTSX_PATH, dotsxPath);
  const today = new Date().toISOString().split('T')[0]; // "2025-09-30"

  // Check if backup already done today
  const lastBackupDate = this.getLastBackupDate(dotsxRelativePath);

  if (lastBackupDate !== today) {
    // Create backup in ~/.backup.dotsx
    this.createBackup(dotsxRelativePath, sourceToBackup);
    this.saveLastBackupDate(dotsxRelativePath, today);
  } else {
    log.info(`Backup already done today for ${displayPath}`);
  }

  // ... rest of existing code ...
}
```

3. Ajouter m√©thodes helper :
```typescript
getLastBackupDate(dotsxRelativePath: string): string | null {
  const metadataPath = path.join(DOTSX_PATH, '.last-backup.json');
  if (!this.isFile(metadataPath)) return null;

  const data = JSON.parse(this.readFile(metadataPath));
  return data[dotsxRelativePath] || null;
}

saveLastBackupDate(dotsxRelativePath: string, date: string): void {
  const metadataPath = path.join(DOTSX_PATH, '.last-backup.json');

  let data = {};
  if (this.isFile(metadataPath)) {
    data = JSON.parse(this.readFile(metadataPath));
  }

  data[dotsxRelativePath] = date;

  this.writeToFile(metadataPath, JSON.stringify(data, null, 2));
}
```

**Tests √† faire:**
- Cr√©er un symlink ‚Üí backup cr√©√©
- Modifier le symlink le m√™me jour ‚Üí backup skip
- Modifier le symlink le lendemain ‚Üí nouveau backup cr√©√©
- V√©rifier que `.last-backup.json` est bien versionn√© dans Git

**B√©n√©fices:**
- R√©duit taille de `~/.backup.dotsx` (pas de backup spam)
- Conforme √† la spec CLAUDE.md
- Garde historique quotidien sur 7 jours

---

### 2. Am√©liorer d√©tection distro Linux
**Priorit√©:** MOYENNE
**Temps estim√©:** 20 min
**Fichiers concern√©s:**
- `src/lib/system.ts` (lignes 96-107)

**Description:**
La d√©tection actuelle lit juste `/etc/os-release` ID field. Probl√®mes :
- Ne d√©tecte pas les d√©riv√©s (Pop!_OS, Linux Mint, Zorin, etc.)
- Pas de fallback si fichier manquant
- Pas de mapping vers domaines parents

**Code actuel (simplifi√©):**
```typescript
getLinuxDistro(): string | null {
  try {
    const data = fs.readFileSync('/etc/os-release', 'utf-8');
    const idMatch = data.match(/^ID=(.+)$/m);
    if (idMatch?.[1]) {
      return idMatch[1].replace(/"/g, '').toLowerCase();
    }
  } catch {
    return null;
  }
  return null;
}
```

**Am√©lioration sugg√©r√©e:**

```typescript
getLinuxDistro(): string | null {
  try {
    // 1. Try /etc/os-release (standard)
    const data = fs.readFileSync('/etc/os-release', 'utf-8');

    // Get ID and ID_LIKE (for derivatives)
    const idMatch = data.match(/^ID=(.+)$/m);
    const idLikeMatch = data.match(/^ID_LIKE=(.+)$/m);

    if (idMatch?.[1]) {
      const id = idMatch[1].replace(/"/g, '').toLowerCase();

      // Direct mapping for derivatives
      const derivatives: Record<string, string> = {
        'pop': 'ubuntu',        // Pop!_OS ‚Üí Ubuntu
        'linuxmint': 'ubuntu',  // Linux Mint ‚Üí Ubuntu
        'zorin': 'ubuntu',      // Zorin ‚Üí Ubuntu
        'elementary': 'ubuntu', // Elementary ‚Üí Ubuntu
        'neon': 'ubuntu',       // KDE Neon ‚Üí Ubuntu
        'manjaro': 'arch',      // Manjaro ‚Üí Arch
        'endeavouros': 'arch',  // EndeavourOS ‚Üí Arch
        'garuda': 'arch',       // Garuda ‚Üí Arch
      };

      // Check if it's a known derivative
      if (derivatives[id]) {
        log.info(`Detected ${id} (derivative of ${derivatives[id]})`);
        return derivatives[id];
      }

      // If ID_LIKE exists, use it (e.g., "ubuntu debian")
      if (idLikeMatch?.[1]) {
        const idLike = idLikeMatch[1].replace(/"/g, '').toLowerCase();
        const likes = idLike.split(' ');

        // Check if any parent is supported
        for (const like of likes) {
          if (['debian', 'ubuntu', 'fedora', 'arch', 'suse'].includes(like)) {
            log.info(`Detected ${id} (based on ${like})`);
            return like;
          }
        }
      }

      return id;
    }
  } catch {
    // Fallback: try lsb_release command
    try {
      const result = execSync('lsb_release -is', { encoding: 'utf-8' });
      return result.trim().toLowerCase();
    } catch {
      return null;
    }
  }

  return null;
}
```

**Tests √† faire:**
- Ubuntu ‚Üí d√©tecte "ubuntu"
- Pop!_OS ‚Üí d√©tecte "ubuntu" (via mapping)
- Manjaro ‚Üí d√©tecte "arch" (via mapping)
- Debian ‚Üí d√©tecte "debian"
- Unknown distro avec ID_LIKE=debian ‚Üí d√©tecte "debian"

**B√©n√©fices:**
- Support des distros d√©riv√©es populaires
- Fallback robuste si `/etc/os-release` manquant
- Meilleur mapping vers package managers existants

---

## üü¢ Version 1.2 - BACKLOG (~6h)

### 3. Tests unitaires
**Priorit√©:** BASSE
**Temps estim√©:** 2-3h

**Description:**
Les scripts de test existent dans `package.json` mais aucun test impl√©ment√© :
```json
"test:unit": "bun test tests/unit",
"test:integration": "bun test tests/integration",
"test": "bun test"
```

**Tests critiques √† cr√©er:**

#### A. `tests/unit/lib/file.test.ts`
```typescript
// Test expandPath
describe('FileLib.expandPath', () => {
  test('converts __home__/ to absolute path', () => {
    const result = FileLib.expandPath('__home__/.zshrc');
    expect(result).toBe('/home/testuser/.zshrc');
  });

  test('converts ~/ to absolute path (legacy)', () => {
    const result = FileLib.expandPath('~/.zshrc');
    expect(result).toBe('/home/testuser/.zshrc');
  });

  test('keeps absolute paths unchanged', () => {
    const result = FileLib.expandPath('/etc/config');
    expect(result).toBe('/etc/config');
  });
});

// Test getDisplayPath
describe('FileLib.getDisplayPath', () => {
  test('converts /home/user to __home__', () => {
    const result = FileLib.getDisplayPath('/home/testuser/.zshrc');
    expect(result).toBe('__home__/.zshrc');
  });

  test('keeps non-home paths unchanged', () => {
    const result = FileLib.getDisplayPath('/etc/config');
    expect(result).toBe('/etc/config');
  });
});

// Test safeSymlink
describe('FileLib.safeSymlink', () => {
  test('creates backup before symlinking', async () => {
    // TODO: Mock fs operations
  });

  test('skips if symlink already correct', async () => {
    // TODO: Mock fs operations
  });
});
```

#### B. `tests/unit/lib/git.test.ts`
```typescript
describe('GitLib.validateGitUrl', () => {
  test('accepts SSH format git@github.com:user/repo.git', () => {
    expect(GitLib.validateGitUrl('git@github.com:user/repo.git')).toBe(true);
  });

  test('rejects HTTPS format', () => {
    expect(GitLib.validateGitUrl('https://github.com/user/repo.git')).toBe(false);
  });

  test('rejects invalid URLs', () => {
    expect(GitLib.validateGitUrl('not-a-git-url')).toBe(false);
  });
});

describe('GitLib.extractRepoInfoFromUrl', () => {
  test('extracts owner and repo from SSH URL', () => {
    const result = GitLib.extractRepoInfoFromUrl('git@github.com:plvo/dotsx.git');
    expect(result).toEqual({ owner: 'plvo', repo: 'dotsx' });
  });

  test('returns null for invalid URL', () => {
    const result = GitLib.extractRepoInfoFromUrl('invalid-url');
    expect(result).toBeNull();
  });
});
```

#### C. `tests/integration/symlink.test.ts`
```typescript
// Test full symlink workflow
describe('Symlink integration', () => {
  test('creates symlink and backup', async () => {
    // TODO: Setup test environment
    // TODO: Create test file
    // TODO: Run symlinkCommand.addLink()
    // TODO: Verify symlink created
    // TODO: Verify backup created
    // TODO: Cleanup
  });
});
```

**Setup requis:**
```bash
bun add -D @types/bun-test
```

**B√©n√©fices:**
- D√©tecte r√©gressions
- Documente comportement attendu
- Facilite refacto future

---

### 4. README.md utilisateur
**Priorit√©:** BASSE
**Temps estim√©:** 1h

**Description:**
Cr√©er documentation compl√®te pour les utilisateurs.

**Structure sugg√©r√©e:**

```markdown
# üöÄ DotsX - Dotfiles Manager

Centralize and version your dotfiles on GitHub with symlinks.

## ‚ú® Features

- üì¶ **Multi-platform**: Linux (Debian, Arch, Fedora, etc.), macOS
- üîó **Symlink management**: Automatic backup + restore
- üîß **Git integration**: Atomic sync, SSH-only
- üíª **IDE configs**: VSCode, Cursor
- ÔøΩÔøΩÔ∏è **Terminal configs**: ZSH, Bash, TMUX
- üìã **Package managers**: apt, snap, flatpak, dnf, pacman, yay, brew
- ü©∫ **Health check**: `dotsx doctor` for diagnostics

## üõ†Ô∏è Installation

### Prerequisites
- Git
- Bun runtime

### Install
\`\`\`bash
git clone https://github.com/user/dotsx.git
cd dotsx
bun install
bun run build
sudo ln -s $(pwd)/dotsx /usr/local/bin/dotsx
\`\`\`

## üöÄ Quick Start

### 1. Initialize from scratch
\`\`\`bash
dotsx
# Choose: üå± From scratch
# Select terminals, IDEs to configure
\`\`\`

### 2. Initialize from existing GitHub repo
\`\`\`bash
dotsx
# Choose: üîß From Git
# Enter: git@github.com:username/dotsx-config.git
\`\`\`

### 3. Run diagnostics
\`\`\`bash
dotsx
# Choose: ü©∫ Doctor
# Review + auto-fix issues
\`\`\`

## üìñ Common Workflows

### Sync changes to GitHub
\`\`\`bash
dotsx ‚Üí üîß Git ‚Üí üîÑ Sync
# Atomic: add + commit + push
\`\`\`

### Pull from another machine
\`\`\`bash
dotsx ‚Üí üîß Git ‚Üí üì• Pull
# Auto-validates structure + symlinks
\`\`\`

### Add new symlink
\`\`\`bash
dotsx ‚Üí üìã Symlinks ‚Üí ‚ûï Add new link
# Enter: ~/.config/myapp/config.yml
# Creates: ~/.dotsx/symlinks/__home__/.config/myapp/config.yml
\`\`\`

### Install packages from list
\`\`\`bash
dotsx ‚Üí üì¶ ubuntu packages ‚Üí apt
# Select packages to install
\`\`\`

## üóÇÔ∏è Directory Structure

\`\`\`
~/.dotsx/
  ‚îú‚îÄ‚îÄ bin/                    # Executable scripts
  ‚îÇ   ‚îú‚îÄ‚îÄ my-script.sh
  ‚îÇ   ‚îî‚îÄ‚îÄ _dotsx-bin.aliases  # Auto-generated aliases
  ‚îú‚îÄ‚îÄ ide/
  ‚îÇ   ‚îú‚îÄ‚îÄ vscode/
  ‚îÇ   ‚îî‚îÄ‚îÄ cursor/
  ‚îú‚îÄ‚îÄ terminal/
  ‚îÇ   ‚îú‚îÄ‚îÄ zsh/
  ‚îÇ   ‚îú‚îÄ‚îÄ bash/
  ‚îÇ   ‚îî‚îÄ‚îÄ tmux/
  ‚îú‚îÄ‚îÄ os/
  ‚îÇ   ‚îî‚îÄ‚îÄ debian/
  ‚îÇ       ‚îú‚îÄ‚îÄ apt.txt         # Package lists
  ‚îÇ       ‚îú‚îÄ‚îÄ snap.txt
  ‚îÇ       ‚îî‚îÄ‚îÄ flatpak.txt
  ‚îî‚îÄ‚îÄ symlinks/
      ‚îî‚îÄ‚îÄ __home__/           # User-agnostic notation
          ‚îú‚îÄ‚îÄ .zshrc
          ‚îî‚îÄ‚îÄ .config/
              ‚îî‚îÄ‚îÄ Code/
                  ‚îî‚îÄ‚îÄ User/
                      ‚îî‚îÄ‚îÄ settings.json

~/.backup.dotsx/              # Automatic backups (7 per file)
  ‚îî‚îÄ‚îÄ symlinks/
      ‚îî‚îÄ‚îÄ __home__/
          ‚îî‚îÄ‚îÄ .zshrc.20250930123456.dotsx.backup
\`\`\`

## ü©∫ Doctor Command

Run full diagnostics:
\`\`\`bash
dotsx ‚Üí ü©∫ Doctor
\`\`\`

Checks:
- ‚úÖ System info
- ‚úÖ Directory structure
- ‚úÖ Git repository status
- ‚úÖ All domain configurations
- ‚úÖ Symlinks validity
- üîß Auto-fix available issues

## üîß Troubleshooting

### Symlink broken after pull
\`\`\`bash
dotsx ‚Üí ü©∫ Doctor
# Review broken symlinks
# Accept auto-fix
\`\`\`

### Git conflict
\`\`\`bash
# Resolve manually
git add .
git commit
dotsx ‚Üí ü©∫ Doctor  # Validate
\`\`\`

### Package manager config missing
\`\`\`bash
dotsx ‚Üí ü©∫ Doctor
# Auto-creates missing configs
\`\`\`

## üìù Configuration

### Add custom OS domain
Edit `src/domains/os.ts`:
\`\`\`typescript
export const myDistro: Domain = {
  name: 'mydistro',
  distro: ['mydistro'],
  type: 'os',
  packageManagers: {
    mypkg: {
      configPath: DOTSX.OS.MYDISTRO.PKG,
      install: 'mypkg install %s',
      remove: 'mypkg remove %s',
      status: 'mypkg list | grep %s',
      defaultContent: '# Packages\\n',
    },
  },
};
\`\`\`

## ü§ù Contributing

Contributions welcome! See CONTRIBUTING.md

## üìÑ License

MIT License
\`\`\`

**Fichier √† cr√©er:** `/README.md` (root)

---

### 5. Support Fish shell
**Priorit√©:** BASSE
**Temps estim√©:** 10 min

**Fichiers concern√©s:**
- `src/domains/terminal.ts`

**Description:**
Le code d√©tecte Fish shell dans `SystemLib.detectShell()` mais il n'y a pas de domain Fish.

**Impl√©mentation:**

```typescript
// src/domains/terminal.ts

export const fishDomain: Domain = {
  name: 'fish',
  type: 'terminal',
  distro: null,
  symlinkPaths: {
    linux: ['~/.config/fish/config.fish', '~/.config/fish/functions'],
    macos: ['~/.config/fish/config.fish', '~/.config/fish/functions'],
  },
};

// Ajouter √† l'export en bas du fichier
```

**Tests √† faire:**
- Utilisateur avec Fish ‚Üí init d√©tecte Fish
- Symlinks cr√©√©s vers `~/.config/fish/config.fish`

---

### 6. Meilleure gestion erreurs
**Priorit√©:** BASSE
**Temps estim√©:** 1-2h

**Description:**
Am√©liorer les messages d'erreur et le logging.

**Impl√©mentations sugg√©r√©es:**

#### A. Codes d'erreur structur√©s
```typescript
// src/lib/errors.ts (nouveau fichier)

export enum DotsxErrorCode {
  GIT_NOT_INSTALLED = 'GIT_NOT_INSTALLED',
  GIT_REMOTE_NOT_FOUND = 'GIT_REMOTE_NOT_FOUND',
  SYMLINK_SOURCE_NOT_FOUND = 'SYMLINK_SOURCE_NOT_FOUND',
  BACKUP_FAILED = 'BACKUP_FAILED',
  PERMISSION_DENIED = 'PERMISSION_DENIED',
}

export class DotsxError extends Error {
  constructor(
    public code: DotsxErrorCode,
    message: string,
    public suggestion?: string,
  ) {
    super(message);
    this.name = 'DotsxError';
  }
}

// Usage:
throw new DotsxError(
  DotsxErrorCode.GIT_NOT_INSTALLED,
  'Git is not installed',
  'Install git: sudo apt install git'
);
```

#### B. Mode debug avec stack traces
```typescript
// src/lib/logger.ts (nouveau fichier)

export const logger = {
  debug(message: string) {
    if (process.env.DOTSX_DEBUG === '1') {
      console.log(`[DEBUG] ${message}`);
    }
  },

  error(error: Error) {
    log.error(error.message);

    if (process.env.DOTSX_DEBUG === '1') {
      console.error(error.stack);
    }
  },
};

// Usage:
try {
  await dangerousOperation();
} catch (error) {
  logger.error(error);
}
```

**Variable d'environnement:**
```bash
DOTSX_DEBUG=1 dotsx  # Affiche stack traces
```

---

## üìä R√©sum√© des priorit√©s

| Version | Items | Temps total | Status |
|---------|-------|-------------|--------|
| v1.0 | 6 | - | ‚úÖ 100% |
| v1.1 | 2 | ~50 min | ‚è≥ 0% |
| v1.2 | 4 | ~6h | üìã Backlog |

---

## üéØ Prochaines √©tapes recommand√©es

1. **Court terme (1h)** : Finir v1.1
   - Backup quotidien automatique
   - Am√©liorer d√©tection distro

2. **Moyen terme (3-4h)** : Tests unitaires de base
   - FileLib tests
   - GitLib tests

3. **Long terme (6h+)** : v1.2 compl√®te
   - README complet
   - Support Fish
   - Gestion erreurs avanc√©e

---

## üí° Id√©es futures (non planifi√©es)

- Commande `dotsx migrate` pour changer de machine
- Support Windows (WSL + PowerShell)
- Interface web pour g√©rer configs
- Plugin system pour domaines custom
- Export/import de configs sans Git
- Chiffrement des configs sensibles
- Commande `dotsx diff` pour comparer machines
- Support Nix package manager
- Auto-update checker

---

**Note:** Ce fichier est maintenu √† jour apr√®s chaque release. Derni√®re mise √† jour : v1.0 (2025-09-30)